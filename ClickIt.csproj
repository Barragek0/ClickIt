<?xml version="1.0" encoding="utf-8"?>
<Project Sdk="Microsoft.NET.Sdk">

  <PropertyGroup>
    <TargetFramework>net8.0-windows</TargetFramework>
    <UseWindowsForms>true</UseWindowsForms>
    <Nullable>enable</Nullable>
    <ImplicitUsings>enable</ImplicitUsings>
    <AssemblyName>ClickIt</AssemblyName>
    <RootNamespace>ClickIt</RootNamespace>
    <PlatformTarget>x64</PlatformTarget>
    <RuntimeIdentifier>win-x64</RuntimeIdentifier>
    <LangVersion>latest</LangVersion>
    <Deterministic>true</Deterministic>
    <!-- Define runtime symbol for ExileCore integration -->
    <DefineConstants>RUNTIME_EXILECORE</DefineConstants>
    <!-- Prevent SDK from generating assembly attributes (we have Properties/AssemblyInfo.cs) -->
    <GenerateAssemblyInfo>false</GenerateAssemblyInfo>
    <!-- Disable implicit compile include because we explicitly list source files -->
    <EnableDefaultCompileItems>false</EnableDefaultCompileItems>
  </PropertyGroup>

  <PropertyGroup Condition=" '$(Configuration)' == '' ">
    <Configuration>Debug</Configuration>
  </PropertyGroup>

  <!-- External ExileCore DLLs are provided by host; pass their folder with /p:exapiPackage=... -->
  <ItemGroup>
    <Reference Include="ExileCore">
      <HintPath>$(exapiPackage)\ExileCore.dll</HintPath>
      <Private>false</Private>
    </Reference>
    <Reference Include="GameOffsets">
      <HintPath>$(exapiPackage)\GameOffsets.dll</HintPath>
      <Private>false</Private>
    </Reference>
    <Reference Include="ProcessMemoryUtilities">
      <HintPath>$(exapiPackage)\ProcessMemoryUtilities.dll</HintPath>
      <Private>false</Private>
    </Reference>
  </ItemGroup>

  <!-- Fallback references for development when exapiPackage is not set -->
  <ItemGroup Condition="'$(exapiPackage)' == ''">
    <Reference Include="ExileCore">
      <HintPath>..\..\PoeHelper\net48\ExileCore.dll</HintPath>
      <Private>false</Private>
    </Reference>
    <Reference Include="GameOffsets">
      <HintPath>..\..\PoeHelper\net48\GameOffsets.dll</HintPath>
      <Private>false</Private>
    </Reference>
    <Reference Include="ProcessMemoryUtilities">
      <HintPath>..\..\PoeHelper\net48\ProcessMemoryUtilities.dll</HintPath>
      <Private>false</Private>
    </Reference>
  </ItemGroup>

  <!-- Exclude UI / rendering / platform input files from coverlet LCOV output when instrumented by coverlet.msbuild -->
  <PropertyGroup>
    <ExcludeByFile>**/Core/ClickItSettings.cs,**/Rendering/**,**/Services/ClickService.cs,**/Services/ShrineService.cs,**/Services/EssenceService.cs,**/Utils/Mouse.cs,**/Utils/Keyboard.cs,**/Utils/InputHandler.cs,**/obj/**/*.*,**/bin/**/*.*</ExcludeByFile>
  </PropertyGroup>

  <ItemGroup>
    <!-- NuGet packages (kept from original project) -->
    <PackageReference Include="coverlet.msbuild" Version="6.0.4">
      <IncludeAssets>runtime; build; native; contentfiles; analyzers; buildtransitive</IncludeAssets>
      <PrivateAssets>all</PrivateAssets>
    </PackageReference>
    <PackageReference Include="ImGui.NET" Version="1.89.7.1" />
    <PackageReference Include="Newtonsoft.Json" Version="13.0.3" />
    <PackageReference Include="Serilog" Version="3.1.1" />
    <PackageReference Include="SharpDX" Version="4.2.0" />
    <PackageReference Include="SharpDX.Mathematics" Version="4.2.0" />
    <PackageReference Include="SharpDX.Direct2D1" Version="4.2.0" />
    <PackageReference Include="SharpDX.DXGI" Version="4.2.0" />
    <PackageReference Include="System.Memory" Version="4.5.5" />
    <PackageReference Include="System.Buffers" Version="4.5.1" />
    <PackageReference Include="System.Runtime.CompilerServices.Unsafe" Version="6.0.0" />
    <PackageReference Include="System.Numerics.Vectors" Version="4.5.0" />
    <PackageReference Include="System.Collections.Immutable" Version="8.0.0" />
  </ItemGroup>

  <!-- Explicit compile list (mirrors original) to avoid auto-including Tests/ -->
  <ItemGroup>
    <!-- Core Classes -->
    <Compile Include="Core\ClickIt.cs" />
    <Compile Include="Core\ClickIt.TestSeams.cs" />
    <Compile Include="Core\ClickIt.Render.cs" />
    <Compile Include="Core\ClickIt.Input.cs" />
    <Compile Include="Core\ClickItSettings.cs" />
    <Compile Include="Core\PluginContext.cs" />

    <!-- Constants -->
    <Compile Include="Constants\AltarModsConstants.cs" />
    <Compile Include="Constants\Constants.cs" />

    <!-- Components -->
    <Compile Include="Components\AltarButton.cs" />
    <Compile Include="Components\PrimaryAltarComponent.cs" />
    <Compile Include="Components\SecondaryAltarComponent.cs" />

    <!-- Properties -->
    <Compile Include="Properties\Settings.Designer.cs">
      <AutoGen>True</AutoGen>
      <DesignTimeSharedInput>True</DesignTimeSharedInput>
      <DependentUpon>Settings.settings</DependentUpon>
    </Compile>
    <Compile Include="Properties\AssemblyInfo.cs" />

    <!-- Services -->
    <Compile Include="Services\AltarMatcher.cs" />
    <Compile Include="Services\AltarParser.cs" />
    <Compile Include="Services\AltarRepository.cs" />
    <Compile Include="Services\AltarScanner.cs" />
    <Compile Include="Services\AltarService.cs" />
    <Compile Include="Services\AltarService.Seams.cs" />
    <Compile Include="Services\AreaService.cs" />
    <Compile Include="Services\ClickService.cs" />
    <Compile Include="Services\ClickService.Seams.cs" />
    <Compile Include="Services\ElementAdapter.cs" />
    <Compile Include="Services\EssenceService.cs" />
    <Compile Include="Services\IElementAdapter.cs" />
    <Compile Include="Services\LabelFilterService.cs" />
    <Compile Include="Services\LabelFilterService.Seams.cs" />
    <Compile Include="Services\LabelService.cs" />
    <Compile Include="Services\ShrineService.cs" />

    <!-- Rendering -->
    <Compile Include="Rendering\AltarDisplayRenderer.cs" />
    <Compile Include="Rendering\DebugRenderer.cs" />
    <Compile Include="Rendering\LazyModeRenderer.cs" />
    <Compile Include="Rendering\StrongboxRenderer.cs" />

    <!-- Utils -->
    <Compile Include="Utils\AltarModMatcher.cs" />
    <Compile Include="Utils\CoroutineManager.cs" />
    <Compile Include="Utils\CoroutineManager.Seams.cs" />
    <Compile Include="Utils\DeferredFrameQueue.cs" />
    <Compile Include="Utils\DeferredFrameQueue.Seams.cs" />
    <Compile Include="Utils\DeferredTextQueue.cs" />
    <Compile Include="Utils\EntityHelpers.cs" />
    <Compile Include="Utils\EntityHelpers.Seams.cs" />
    <Compile Include="Utils\ErrorHandler.cs" />
    <Compile Include="Utils\IndexConstants.cs" />
    <Compile Include="Utils\InputHandler.cs" />
    <Compile Include="Utils\Keyboard.cs" />
    <Compile Include="Utils\LabelUtils.Seams.Adapter.cs" />
    <Compile Include="Utils\LabelUtils.Seams.cs" />
    <Compile Include="Utils\LabelUtils.cs" />
    <Compile Include="Utils\LockManager.cs" />
    <Compile Include="Utils\ModIndexConstants.cs" />
    <Compile Include="Utils\Mouse.cs" />
    <Compile Include="Utils\PerformanceMonitor.cs" />
    <Compile Include="Utils\TextHelpers.cs" />
    <Compile Include="Utils\WeightCalculator.cs" />
  </ItemGroup>

  <ItemGroup>
    <None Include=".editorconfig" />
    <None Include="app.config" />
    <None Include="packages.config" />
    <None Include="Properties\Settings.settings">
      <Generator>SettingsSingleFileGenerator</Generator>
      <LastGenOutput>Settings.Designer.cs</LastGenOutput>
    </None>
  </ItemGroup>

  <Target Name="AfterBuild">
    <Copy SourceFiles="$(ProjectDir)$(OutputPath)ClickIt.dll" DestinationFolder="C:\1.Path stuff\PoeHelper\net48\Plugins\Compiled\ClickIt" ContinueOnError="true" />
    <Exec Command="&quot;$(ProjectDir)run-tests.bat&quot;" Condition="Exists('$(ProjectDir)Tests\ClickIt.Tests.csproj') and '$(Configuration)' == 'Debug' and '$(SkipRunTests)' != 'true'" ContinueOnError="false" WorkingDirectory="$(ProjectDir)" />
  </Target>

  <!-- Allow the test project to access internal types without reflection -->
  <ItemGroup>
    <AssemblyAttribute Include="System.Runtime.CompilerServices.InternalsVisibleTo">
      <_Parameter1>ClickIt.Tests</_Parameter1>
    </AssemblyAttribute>
  </ItemGroup>

</Project>